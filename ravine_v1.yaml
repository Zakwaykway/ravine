meta:
  engine: 4.1.0
  name: ravine_v1
  author: zakwaykway
  url: https://github.com/zakwaykway/ravine
  
units:
  kx: u # spacing
  ky: u
  xiao_x: 18 # xiao measurements
  xiao_y: 21
  $default_height: 0.5
  $default_width: 0.5
  switch: 16 # switch size
  b: 0.1kx # bind
  p: 0.5kx # polygon

  mcu_x: 1 # manual offset
  mcu_y: 1.5

  pinky_splay: 5
  ring_stagger: 0.7ky
  ring_splay: 3
  middle_stagger: 0.25ky
  index_stagger: -0.5ky
  inner_stagger: -0.4ky
  thumb_base_angle: 0 # -16
  thumb_splay: -0
  thumb_stagger: -0.125ky
  thumb_shiftx: 0.3kx # changes location -- 0.45kx
  thumb_shifty: -1.125ky

  slider_x: 9 # 9.5 smd
  slider_y: 3.5 # 7.75 smd
  reset_x: 8
  reset_y: 5.6
    


points:
  zones:
    matrix: # mx is top side, 90ยบ turns it c.clockw.
      anchor.shift: [160, -185]
      rotate: pinky_splay + ring_splay
      key:
        spread: kx
        padding: ky
        autobind: 0
      rows:
        bottom.row_net: P6
        home.row_net: P5
        top.row_net: P4
      columns.pinky:
        key.column_net: P0
        rows.bottom.skip: true
        rows.home.adjust.rotate: 180
      columns.ring:
        key:
          stagger: ring_stagger
          splay: -pinky_splay
          column_net: P1
        rows.bottom.column_net: P0
      columns.middle:
        key:
          stagger: middle_stagger
          splay: -ring_splay
          column_net: P2
          origin: [-ky/2, -kx/2]
        rows.bottom.column_net: P1
      columns.index:
        key:
          stagger: index_stagger
          column_net: P3
        rows.bottom.column_net: P2
      columns.inner:
        key:
          stagger: inner_stagger
          column_net: P3
        rows:
          top.row_net: P6
          home.row_net: P7
          bottom.skip: true
    thumb: # thumbs
      key:
        $extends: points.zones.matrix.key
        row_net: P7
      anchor:
        ref: matrix_index_bottom
        shift: [thumb_shiftx, thumb_shifty]
      columns:
        tucky.key:
          splay: thumb_base_angle
          column_net: P1
        reachy.key:
          rotate: 90
          splay: thumb_splay
          stagger: thumb_stagger
          column_net: P2
    encoder: # thumbs
      key:
        $extends: points.zones.matrix.key
        column_net: P0
        row_net: P7
      anchor:
        ref: matrix_middle_bottom
        shift: [0, -kx]
        # ref: thumb_tucky
        # shift: [-ky, -2thumb_stagger]
      columns.enccol:

    ref_cbl.anchor.aggregate:
      method: intersect
      parts:
        - ref: matrix_pinky_home
          shift: -kx/2
        - ref: thumb_tucky
          shift: -ky/2
          rotate: 90
    ref_mcu:  # mcu ref
      key.width: xiao_x
      key.height: xiao_y
      anchor:
        ref: encoder_enccol
        shift: [-kx/2-xiao_y/2, -middle_stagger+ky/2-xiao_x/2-3]
        rotate: 90
    #ref_cmcu.anchor.aggregate:
    #  method: intersect
    #  parts:
    #    - ref: thumb_reachy 
    #      shift: kx/2
    #    - ref: ref_mcu
    #      shift: xiao_y/2
    #      rotate: 90

    mcu:
      anchor:
        ref: ref_mcu
      key:
        width: xiao_x
        height: xiao_y
    reset: # reset switch
      key:
        width: reset_x
        height: reset_y
      anchor:
        ref: matrix_inner_home
        shift: [-kx/2+reset_x/2, -ky/2-reset_y/2]
    slider: # power switch
      key:
        width: slider_x
        height: slider_y
      anchor:
        ref: matrix_inner_home
        shift: [kx/2-slider_y/2, -ky/2-slider_x/2] 
        rotate: 90
    jst: # battery connector
      anchor:
        ref: matrix_ring_bottom
        shift: [kx/2-12.35/2, -ky/2-6.9/2]
        rotate: -90
      key:
        width: 6.9
        height: 12.35
        from: battery
        to: GND
      columns.jst.key:
    #battery:
    #  key:
    #    width: 80
    #    height: 10
    #  anchor:
    #    ref: thumb_reachy
    #    shift: [kx/2-80/2, -ky/2-10/2]
    #zones.bat54c:
    #  key: 
    #    width: 3.1
    #    height: 2.9


outlines:
    _key_outline:
      - what: rectangle
        bound: true
        size: switch
        where: /matrix|thumb|encoder/
    _body_poly:
      - what: polygon # edge wedges, main shape
        points:
          - ref: thumb_tucky
            shift: [-p, -p]
          - ref: matrix_pinky_home
            shift: [-p, -p]
          - ref: ref_mcu
            shift: [-xiao_x/2, xiao_y/2]
          - ref: thumb_reachy
            shift: [kx/2, ky/2]
    _body_hull:
      - what: hull
        concavity: 0
        points:
          - ref: matrix_pinky_home
          - ref: matrix_pinky_top
          - ref: matrix_ring_top
          - ref: matrix_middle_top
          - ref: matrix_index_top
          - ref: encoder_enccol
          - ref: matrix_inner_top
          - ref: matrix_inner_home
          - ref: thumb_reachy
          - ref: thumb_tucky
          - ref: ref_mcu
          - ref: matrix_ring_bottom

    _board:
      - _key_outline
      #- _body_poly
      - _body_hull

    _switches:
      - what: rectangle
        size: 14
        where: /matrix|thumb|encoder/
        corner: 0.5
    _keycaps:
      - what: rectangle
        size: [kx, ky]
        where: /matrix|thumb/
    _mcu:
      - what: rectangle
        where: mcu
        size: [xiao_x, xiao_y]
    _mcu_hole:
      - what: rectangle
        where: mcu
        size: [xiao_x+2, xiao_y+2]
        fillet: 1
    _reset:
      - what: rectangle
        where: reset
        size: [reset_x, reset_y]
    _slider:
      - what: rectangle
        where: slider
        size: [slider_x, slider_y]
    _jst:
      - what: rectangle
        where: /jst_.*/
        size: [6.9, 12.35]

    debug:
      - _board
      - ^_switches
      - ^_keycaps
      - ^_mcu
      - ^_mcu_hole
      - ^_reset
      - ^_slider
      - ^_jst
    top_view:
      - _board
      - ^_keycaps
      - ^_mcu
    switchplate:
      - _board
      - -_switches
      - operation: subtract
        name: _mcu_hole
        fillet: 1

pcbs:
  ravine_v1:
    template: kicad8
    outlines.main.outline: _board
    footprints:
      switch: #########
        what: sw_combo
        where:
          - /matrix|thumb|encoder/
        params:
          from: "{{row_net}}"
          to: "{{colrow}}"
          center: GND
      encoder: #########
        what: ceoloide/rotary_encoder_ec11_ec12
        where: /encoder/
        params:
          reversible: true
          include_plated_mounting_holes: false
          # adjust the two values below
          mounting_holes_position: 8
          encoder_pads_position: 8.254
          S1: "{{row_net}}"
          S2: "{{colrow}}"
          A: P8
          C: P9
      diode: #########
        what: diode_rev
        where: /matrix|thumb|encoder/
        params:
          from: "{{colrow}}"
          to: "{{column_net}}"
        adjust:
          shift: [0, -8.5]
          rotate: 180
      xiao: #########
        what: xiao
        where: mcu
      reset: #########
        what: button
        where: reset
        params:
          designator: RESET
          from: RST
          to: GND
      slider: #########
        what: placeholder
        where: slider
        params:
          designator: SLIDER
          P1: battery
          P2: BAT_POS
          P3: ''
      jst: #########
        what: ceoloide/battery_connector_jst_ph_2
        where: /jst/
        params:
          reversible: true
          BAT_P: "{{from_net}}"
          BAT_N: "{{to_net}}"
      rgb:
        what: ceoloide/led_sk6812mini-e
        where: /blank blank|blank/
        adjust.shift: [0, 0]
        params:
          reversible: true
          reverse_mount: false
          include_traces_vias: false
          P2: P11
          P4: P10
          
  ravine_switchplate:
    outlines.main.outline: switchplate


      #switches_main:
      #  what: ceoloide/switch_choc_v1_v2
      #  where: /matrix_.*|thumb_.*|encoder_.*/
      #  params:
      #    from: "{{row_net}}"
      #    to: "{{colrow}}"
      #    include_plated_holes: true
      #    include_centerhole_net: true
      #    choc_v1_stabilizers_diameter: 1.9
      #    reversible: true
      #    hotswap_pads_same_side: true
      #    include_keycap: true

      #bat54c: #########
      #  what: placeholder
      #  where:
      #    - matrix_pinky_top
      #    - matrix_middle_top
      #    - matrix_pinky_home
      #    - matrix_middle_home
      #    - matrix_ring_bottom
      #    - matrix_index_bottom
      #    - /encoder_.*/
      #    - thumb_tucky
      #  adjust:
      #    shift: [kx/2, -0.5]
      #    rotate: 0
      #  params:
      #    designator: BAT54C
      #    P1: "{{colrow}}"
      #    P2: "{{column_net}}"


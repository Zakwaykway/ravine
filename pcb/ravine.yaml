meta:
  name: ravine
  engine: 4.2.1
  derived_from: ezxzeng/sweep_squared_rot
  author: zakwaykway
units:
  kx: u # spacing
  ky: kx
  px: 18 # keycap size
  py: px

  $default_width: 18 # can't be px, 
  $default_height: 18 # as it throws an error?? 
  $default_autobind: 0
  # todo reading: filters. Add a tag to all keys, encoder included.
  # Remove extraneous naming. create points for every diode?

  pinky_splay: 5
  pinky_stagger: 0.55ky # pinky to ring
  ring_splay: 3
  ring_stagger: 0.25ky # ring to middle
  index_stagger: -0.45ky # middle to index
  inner_stagger: -0.4ky #index to inner
  thumb_splay: 18
  thumb_x: 0.25 # changes thumb's origin
  thumb_y: 0

  corner_x: 0.5
  corner_y: 0

  center_x: 6
  center_y: 4.5
  center_r: -14 - pinky_splay/3 - ring_splay/3
  
  gap: 0.1 # gaps from edges
  # ==================== object sizes ====================
  square: 102
  xiao_x: 17.8
  xiao_y: 21
  trrs_x: 6.1
  trrs_y: 13.2
  reset_x: 8 # alps skqg
  reset_y: 5.6
  slider_x: 9.5 # MSS22D18 SMT
  slider_y: 7.75
  jst_x: 6
  jst_y: 12.5 # including male
  coin_x: 25.7 # bs-8 
  coin_y: 15.7

points.zones:
  zero.rows: # [0, 0, 0]
  matrix: # mx is top side, 90º turns it c.clockw.
    anchor: 
      shift: [150, -150] # move all
      rotate: center_r+pinky_splay+ring_splay
    key:
      spread: kx
      padding: ky
      tags: keys
    rows:
      bottom.row_net: P2
      home.row_net: P1
      top.row_net: P0
    columns.pinky: # invert home's nets
      key.col_net: P0
      rows.top.key.row_net: P4
      rows.home.adjust.rotate: 180
      rows.bottom.skip: true
    columns.ring:
      key.col_net: P1
      rows.home.row_net: P4
      key:
        stagger: pinky_stagger
        splay: -pinky_splay
        origin: [-kx/2, -ky/2+ky-pinky_stagger] # set origin as tangent pinky_home's corner
    columns.middle:
      key.col_net: P2
      rows.bottom.row_net: P4
      key:
        stagger: ring_stagger
        splay: -ring_splay
        origin: [-kx/2, -ky/2]
    columns.index:
      key.col_net: P3
      key.stagger: index_stagger
      rows.bottom.row_net: 
    columns.inner:
      key.col_net: P4
      key.stagger: inner_stagger
      rows.bottom.skip: true
  center:
    anchor:
      - ref: matrix_middle_top
        shift: [0, -2.5ky]
      - orient: -center_r
        shift: [center_x, center_y]
    key.width: square  # size of board outline
    key.height: square # 102mm^2 for jlc special price
  encoder: # potentially invert nets for pretty diode
    key.row_net: P3
    key.col_net: P2
    anchor.ref: matrix_middle_bottom
    anchor.shift: [0, -ky]
  thumb: # potentially invert nets for pretty diode
    key.row_net: P3
    key.col_net: P0
    key.name: matrix_thumb
    key.rotate: center_r - thumb_splay -90
    anchor.ref: center
    anchor.shift: [square/2-kx/2+thumb_x, -square/2+ky/2]
  corner: # potentially invert nets for pretty diode
    key.col_net: P3 
    key.row_net: P4
    key.name: matrix_corner
    anchor.ref: center
    anchor.shift: [-square/2+kx/2+corner_x, -square/2+ky/2+corner_y]
  xiao: # xiao
    key.width: xiao_x
    key.height: xiao_y
    anchor.ref: [matrix_index_top, center]
    anchor.shift: [square/2-xiao_x/2, square/2-xiao_y/2]
  slider: # power switch
    key.width: slider_x
    key.height: slider_y
    anchor:
      - ref: matrix_corner
        shift: [kx/2 + slider_x/2 + 8, 0]
      - ref: center
        shift: [0, -square/2 + slider_y/2 + 0.5]
        affect: y
  reset: # reset switch
    key.width: reset_x
    key.height: reset_y
    anchor:
      - ref: slider
        shift: [slider_x/2 + 2 + reset_x/2, 0]
      - ref: center
        shift: [0, -square/2 + reset_y/2 + 2]
        affect: y
  trrs:
    key.width: trrs_x
    key.height: trrs_y
    key.origin: [trrs_x/2, trrs_y/2]
    key.splay: center_r
    anchor:
      - ref: center
        shift: [square/2-trrs_x/2, 0]
      - ref: matrix_inner_home
        shift: [kx/2+trrs_x/2+1, 0]
        affect: y
  jst: # battery connector
    key.width: jst_x
    key.height: jst_y
    anchor:
      - ref: center
        shift: [0, -square/2]
      - orient: -90
        shift: [-jst_x/2, 0]
  cr2032:
    key.width: coin_x
    key.height: coin_y
    anchor:
      - ref: center
        shift: [square/2-coin_x/2, 0]
      - ref: 
        - ref: matrix_inner_home
          shift: [kx/2, -ky/2-1.5]
          affect: y
        shift: [0, -coin_y/2]
        affect: y 

outlines:
  # =============== components =============
  _xiao:
    - what: rectangle
      where: xiao
      size: [xiao_x, xiao_y]
      corner: 1.5
  _xiao_extra:
    - what: outline
      name: _xiao
      expand: 1
  _reset:
    - what: rectangle
      where: reset
      size: [reset_x, reset_y]
  _slider:
    - what: rectangle
      where: slider
      size: [slider_x, slider_y]
  _jst:
    - what: rectangle
      where: jst
      size: [jst_x, jst_y]
  _cr2032:
    - what: rectangle
      where: cr2032
      size: [coin_x, coin_y]
  _trrs:
    - what: rectangle
      where: trrs
      size: [trrs_x, trrs_y]
      
  # ================= core =================
  _key_footprint:
    - what: polygon
      where: /matrix/
      points:
        - ref: zero
          shift: [2.54+gap, 6.73+gap] # m ring
        - ref: zero
          shift: [7.365+gap, 6.33+gap] # m t pad t
        - ref: zero
          shift: [8.635+gap, 3.79+gap] # m b pad t 
        - ref: zero
          shift: [8.635+gap, 1.29+gap] # m b pad b
        - ref: zero
          shift: [9.57+gap, -2.45-gap] # c t pad t
        - ref: zero
          shift: [9.57+gap, -5.05-gap] # c t pad b
        - ref: zero
          shift: [4.57+gap, -7.25-gap] # c b pad b
        - ref: zero
          shift: [0, -7.6-gap] # c ring
        - ref: zero
          shift: [-4.57-gap, -7.25-gap] # c b pad b
        - ref: zero
          shift: [-9.57-gap, -5.05-gap] # c t pad b
        - ref: zero
          shift: [-9.57-gap, -2.45-gap] # c t pad t
        - ref: zero
          shift: [-8.635-gap, 1.29+gap] # m b pad b
        - ref: zero
          shift: [-8.635-gap, 3.79+gap] # m b pad t 
        - ref: zero
          shift: [-7.365-gap, 6.33+gap] # m t pad t
        - ref: zero
          shift: [-2.54-gap, 6.73+gap] # m ring
    #- what: rectangle
    #  use rectangles instead of polygons?


  _keys:
    - what: rectangle
      where: /matrix|encoder/
      size: [px, py]
  _keycaps:
    - what: rectangle
      where: /matrix/
      size: [px, py]
    - what: circle
      where: encoder
      radius: 14.4/2
      operation: stack
  _key_cutouts:
    - what: rectangle
      where: /matrix|encoder/
      size: 14
  _limits:
    - what: rectangle
      where: center
      size: [square, square]
  _pcb_out: #test lowkey
    - what: path
      segments: 
        - type: line # [edge, -edge] to  [-edge, corner]
          points:
            - ref: center           # bot right
              shift: [square/2, -square/2]
            - ref: center           # bot left
              shift: [-square/2, -square/2]
            - ref:       #[-edge, corn_key top left]
              - ref: center
                shift: [-square/2, 0]
              - ref: matrix_corner
                shift: [0, ky]
                affect: y
        - type: bezier # [-edge, corner] to pinky_top
          points:
            - ref: matrix_pinky_home    # pinky_home bot left
              orient: matrix_pinky_top  # home is rotated. reset º
              shift: [-kx/2-0.25, 0.15ky]
            - ref: matrix_pinky_top # pinky top corner
              shift: [-kx/2-0.25, 0.3ky]
        - type: bezier # pinky_top to [-xiao, xiao]
          points:
            - ref: matrix_ring_top # ring top
              shift: [-0.4kx, 0.6ky]
            - ref:                 # [middle, square]
              - ref: matrix_middle_top
                shift: [0, 1.001ky/2]
              - ref: center
                shift: [0, square/2]
                affect: y
            - ref: xiao            # xiao top left
              shift: [-xiao_x/2, xiao_y/2-1.5]
        - type: line # [-xiao, xiao] to bottom edge
          points:
            - ref: xiao             # xiao top right
              shift: [xiao_x/2, xiao_y/2-2]               
  _testline: #works
    - what: path
      segments: 
        - type: bezier
          points:
            - ref: matrix_pinky_top
              shift: [-kx/2-0.25, 0.3ky]
            - ref: matrix_ring_top
              shift: [-0.4kx, 0.6ky]
            - ref: 
              - ref: matrix_middle_top
                shift: [0, ky/2]
                affect: x
              - ref: center
                shift: [0, square/2]
                affect: y
            - ref: xiao
              shift: [-xiao_x/2, xiao_y/2-1.5]
        - type: line
          points:
            - ref: xiao
              shift: [xiao_x/2, xiao_y/2-2]    
            - ref: center
              shift: [square/2, -square/2]
            - ref: center
              shift: [-square/2, -square/2]
            - ref: 
              - ref: matrix_pinky_home
                orient: matrix_pinky_top
                shift: [-kx/2-0.25, 0.15ky]
                affect: y
              - ref: center
                shift: [-square/2, 0]
                affect: x

  # ================= outlines ===============            
  test_outline:
    - _pcb_out
    - ^_key_footprint
    - ^_limits
  preview:
    - _keycaps
    - ^_pcb_out
    - ^_xiao
  pcb_o:
    - name: _pcb_out 
      fillet: 3
  _plate_out:
    - name: _pcb_out
      where.shift: [-1, 1]
    - name: _xiao # needs a smaller fillet, 1-2, to trigger immediately
      operation: subtract
      fillet: 0
    - name: _cr2032
      operation: subtract
      fillet: 0
    - name: _slider
      operation: subtract
    - name: _reset # small — candidate for small fillet
      operation: subtract
      fillet: 0
    - name: _jst
      operation: subtract
  plate_o:
    - name: _plate_out
      fillet: 0
    - name: _key_cutouts
      operation: subtract

pcbs:
  ravine:
    template: kicad8
    outlines.main.outline: pcb_o
    footprints:
      switches:
        what: sw_combo
        where: /none/ #/matrix|encoder/
        params:
          to: "{{row_net}}" # > switch
          from: "{{colrow}}" # > diode
          center: GND
      encoder: 
        what: ceoloide/rotary_encoder_ec11_ec12
        where: /encoder/
        params:
          reversible: true
          include_plated_mounting_holes: false
          mounting_holes_position: 8
          encoder_pads_position: 8.325
          S1: "{{colrow}}"
          S2: "{{row_net}}"
          A: enc1
          C: enc2
      diode: &diode
        what: diode_rev
        where: /matrix_(?!pinky_home|thumb|corner)/ 
        params:
          from: "{{colrow}}" # > diode
          to: "{{col_net}}" # > mcu
        adjust:
          shift: [0, -9.5]
          rotate: 180
      diode_a1:
        <<: *diode
        where: 
          - matrix_pinky_home
          - matrix_corner
        adjust.shift: [0, 8]
      diode_a2:
        <<: *diode
        where: 
          - ref: matrix_thumb
            shift: [0, -9.5]
            rotate: 180
      diode_a3:
        <<: *diode
        where: 
          - ref: matrix_corner
            shift: [0, 8]
            rotate: 180
      diode_a4:
        <<: *diode
        where: 
          - ref: encoder
            shift: [0, -10]
            rotate: 180
      rgb:
        what: ceoloide/led_sk6812mini-e
        where: /led/
        params:
          P2: "{{led_out}}"
          P4:  "{{led_in}}"
      xiao: # commented because it prevents preview
        what: placeholder
        #what: xiao
        where: xiao
        params:
          P4: trrs
          P5: trrs
          #P6: P4
          #P7: interrupt
          #P8: blank # right side
          #P9: blank
          #NFC1: blank
          #NFC2: blank
      reset: &reset
        what: button
        where: reset
        params:
          from: GND
          to: RST
      reset_tht:
        <<: *reset
        what: tht_button
      slider: # add jumpers to the slider
        what: placeholder
        where: slider
        params:
          P1: battery
          P2: BAT_POS
          P3: unconnected
      trrs:
        what: ceoloide/trrs_pj320a
        where: trrs
        params:
          reversible: true
          symmetric: true
          TP: VCC
          R2: trrs
          SL: GND
      jst:
        what: ceoloide/battery_connector_jst_ph_2
        where: jst
        params:
          reversible: true
          BAT_P: battery
          BAT_N: GND
      #coin_cell:
      #  what: cr2032
      #  where: cr2032
      #  params:
      #    BAT_P: battery
      #    GND: GND
  ravine_plate:
    template: kicad8
    outlines.main.outline: plate_o

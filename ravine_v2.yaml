meta:
  name: ravine
  engine: 4.1.0
  derived_from: ezxzeng/sweep_squared_rot
  author: zakwaykway
units:
  kx: u # spacing
  ky: u
  px: 18.5 # keycap size
  py: 18.5
  sw: 16

# switches' nets & diodes' direction can be flipped to facilitate routing

  pinky_splay: 5
  pinky_stagger: 0.6ky # pinky-ring
  ring_splay: 0
  ring_stagger: 0.25ky # ring-middle
  index_stagger: -0.5ky # middle-index
  inner_stagger: -0.4ky #index-inner
  thumb_splay: 16
  thumb_x: 0*0.05kx # changes thumb's origin
  thumb_y: 0

  corner_x: 1
  corner_y: 1

  center_x: 6
  center_y: 3.5
  center_r: -14 + pinky_splay/2 + ring_splay
  
  # ==================== object sizes ====================
  gap: 2 # gaps between each component
  square: 102
  xiao_x: 17.8
  xiao_y: 21
  trrs_x: 0
  trrs_y: 0
  reset_x: 8
  reset_y: 5.6
  slider_x: 9.5
  slider_y: 7.75
  jst_x: 6
  jst_y: 12.5 # including male

points.zones:
  matrix: # mx is top side, 90ยบ turns it c.clockw.
    anchor: 
      shift: [150, -150] # MOVE ALL
      rotate: center_r+pinky_splay+ring_splay
    key:
      spread: kx
      padding: ky
      autobind: 0
      tags: keys
      bind: [px/2,py/2]
    rows:
      bottom.row_net: row2
      home.row_net: row1
      top.row_net: row0
    columns.pinky:
      key.column_net: col0
      rows.bottom.skip: true
      rows.home.adjust.rotate: 180
    columns.ring:
      key:
        stagger: pinky_stagger
        splay: -pinky_splay
        column_net: col1
        origin: [kx/2, -ky/2+pinky_stagger] # set origin as tangent pinky_home's corner
      rows.bottom.column_net: col0
    columns.middle:
      key:
        stagger: ring_stagger
        splay: -ring_splay
        column_net: col2
        origin: [-kx/2, -ky/2]
      rows.bottom.column_net: P1
    columns.index:
      key:
        stagger: index_stagger
        column_net: col3
      rows.bottom.column_net: col2
    columns.inner:
      key:
        stagger: inner_stagger
        column_net: col3
        row_net: row3
      rows:
        top.row_net: row2
        bottom.skip: true
  center:
    anchor:
      - ref: matrix_middle_top
        shift: [0, -2.5ky]
      - orient: -center_r
        shift: [center_x, center_y]
    key.width: square  # size of board outline
    key.height: square # 102mm^2 for jlc special price
  encoder:
    key.column_net: col0
    key.row_net: row3
    anchor.ref: matrix_middle_bottom
    anchor.shift: [0, -ky]
  thumb:
    key.row_net: row3
    key.column_net: col2
    key.name: matrix_thumb
    anchor.ref: center
    anchor.shift: [square/2-kx/2+thumb_x, -square/2+ky/2]
  corner:
    key.column_net: col0
    key.row_net: row3
    key.name: matrix_corner
    anchor.ref: center
    anchor.shift: [-square/2+kx/2+corner_x, -square/2+ky/2+corner_y]
  xiao: # xiao location
    key.width: xiao_x
    key.height: xiao_y
    anchor.ref: center
    anchor.shift: [-square/2, -square/2]
    key.adjust:
      orient: 90
      shift: [xiao_x/2, -xiao_y/2]
  xiao2:
    key.width: xiao_x
    key.height: xiao_y
    anchor.ref: center
    anchor.shift: [square/2, square/2]
    key.adjust:
      shift: [-xiao_x/2, -xiao_y/2]
  reset: # reset switch
      key.width: reset_x
      key.height: reset_y
      anchor:
        ref: center
        shift: [-square/2+2, -square/2+xiao_x+5]
      key.adjust:
        orient: 90
        shift: [reset_x/2, -reset_y/2]
  slider: # power switch
    key.width: slider_x
    key.height: slider_y
    anchor:
      ref: center
      shift: [-square/2, -square/2+xiao_x+5] 
    key.adjust:
      orient: 90
      shift:
  jst: # battery connector
    anchor:
      ref: center
      shift: [0, -square/2]
    key:
      adjust: 
        orient: -90
        shift: [-jst_x/2, 0]
      width: jst_x
      height: jst_y
outlines:
  # ================= core =================
  _keys:
    - what: rectangle
      where: /matrix|encoder/
      size: [kx, ky]
  _keycaps:
    - what: rectangle
      where: /matrix/
      # bound: true
      size: [px, py]
    - what: circle
      where: encoder
      radius: 14.4/2
      operation: stack
  _key_cutouts:
    - what: rectangle
      where: /matrix|encoder/
      size: 16
  _limits:
    - what: rectangle
      where: center
      size: [square, square]
  top_arc:
    - what: path
      segments: 
        - type: line
          points:
            - ref: center
              shift: [square/2, square/2]
            - ref: center
              shift: [square/2, -square/2]
            - ref: center
              shift: [-square/2, -square/2]
            - ref: matrix_pinky_top
              shift: [-kx/2, 0]
              affect: y
        - type: arc
          points:
            - ref: matrix_middle_top
              shift: [0, ky/2]
            - ref: matrix_inner_top
              shift: [kx/2, ky]
        
  # =============== components =============
  _xiao:
    - what: rectangle
      where: xiao
      size: [xiao_x, xiao_y]
      corner: 1.5
  _xiao_extra:
    - what: outline
      name: _xiao
      expand: 1
  _reset:
    - what: rectangle
      where: reset
      size: [reset_x, reset_y]
  _slider:
    - what: rectangle
      where: slider
      size: [slider_x, slider_y]
  _jst:
    - what: rectangle
      where: jst
      size: [jst_x, jst_y]
  # ================= outlines ===============
  test:
    - _keycaps
    - ^top_arc
    - ^_limits
    - ^_xiao_extra
  keys:
    - what: rectangle
      where: /matrix/
      bound: true
  pcb:
    - top_arc
pcbs:
  ravine:
    template: kicad8
    outlines:
      main:
        outline: pcb
    footprints:
      switch:
        what: sw_combo
        where: /matrix|encoder/
        params:
          from: "{{row_net}}"
          to: "{{colrow}}"
          center: GND
      #encoder:    # commented because it prevents preview
      #  what: ceoloide/rotary_encoder_ec11_ec12
      #  where: /encoder/
      #  params:
      #    reversible: true
      #    include_plated_mounting_holes: false
      #    # adjust the two values below
      #    mounting_holes_position: 8
      #    encoder_pads_position: 8.254
      #    S1: "{{row_net}}"
      #    S2: "{{colrow}}"
      #    A: P8
      #    C: P9
      diode: #########
        #what: diode_rev
        what: ceoloide/diode_tht_sod123
        where: 
          - ref: matrix_pinky_home
            rotate: 180
          # - /matrix_(?!pinky_home)|encoder/
        params:
          from: "{{colrow}}"
          to: "{{column_net}}"
        adjust:
          shift: [0, -9.5]
          rotate: 180
      #mcu: # commented because it prevents preview
      #  what: xiao
      #  where: mcu
      #  params:
      #    P0: col0
      #    P1: col1
      #    P2: col2
      #    P3: col3
      #    P4: HFREQ
      #    P5: HFREQ
      #    P6: row1
      #    P7: row2
      #    P8: row3
      #    P9: enc
      #    NFC1: enc1
      #    NFC2: enc2
      reset:
        what: button
        where: reset
        params:
          from: GND
          to: RST
      slider: # add jumpers to the slider
        what: placeholder
        where: slider
        params:
          P1: battery
          P2: BAT_POS
          P3: unconnected
      jst:
        what: ceoloide/battery_connector_jst_ph_2
        where: jst
        params:
          BAT_P: battery
          BAT_N: GND
      coin_cell:
        what: cr2032
        where: cr2032
        params:
          GND: GND
          BAT_P: battery